<!DOCTYPE html>
<html lang="es">
    <head>
        <meta charset="utf-8"/>
        <meta name="viewport" content="width=device-width, initial-scale=1"/>
        <title>Kurtis fumando</title>

        <!-- Librerías desde CDN -->
        <script src="https://cdn.jsdelivr.net/npm/aframe@1.5.0/dist/aframe.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/mind-ar/dist/mindar-image-aframe.prod.js"></script>
        <!-- Componente de animación de sprites -->
        <script src="https://cdn.jsdelivr.net/npm/aframe-sprite-animation-component@3.8.0/dist/aframe-sprite-animation-component.min.js"></script>

        <style>
            html,body { margin:0; height:100%; overflow:hidden; background:#000; }
                #ui {
                    position:fixed; inset:0; display:flex; flex-direction:column;
                    align-items:center; justify-content:center; gap:12px; z-index:10; color:#fff;
                    background: radial-gradient(ellipse at center, rgba(0,0,0,.7) 0%, rgba(0,0,0,.4) 60%, rgba(0,0,0,0) 100%);
                    text-align:center; padding:24px;
                }
                button {
                    padding:12px 18px; font-size:16px; border-radius:12px; border:none; cursor:pointer;
                }
                #photoBtn, #camBtn {
                    position:fixed; bottom:16px; z-index:11; display:none;
                    background:#fff;
                }
                #photoBtn { right:16px; }
                #camBtn   { left:16px; }
                .hidden { display:none; }
        </style>
    </head>

    <body>
        <!-- UI inicial -->
        <div id="ui">
            <h2>Kurt fumando en Nirvana's</h2>
            <p>Apunta al marcador y toca “Entrar”.</p>
            <button id="startBtn">Entrar</button>
            <small>Si no ves la cámara, asegúrate de abrir la página por HTTPS.</small>
        </div>

        <button id="camBtn">Cambiar cámara</button>
        <button id="photoBtn">Foto</button>

        <!-- Escena AR (no autoStart: se arranca con el botón) -->
        <a-scene
            mindar-image="imageTargetSrc: ./targets.mind; autoStart: false;"
            renderer="colorManagement: true, physicallyCorrectLights"
            vr-mode-ui="enabled: false"
            device-orientation-permission-ui="enabled: false"
        >
            <a-assets>
                <!-- El spritesheet PNG con transparencia -->
                <img id="kurtSheet" src="./spritesheet_kurt.png" />
                <!-- Habilita el componente screenshot de A-Frame para el botón Foto -->
                <a-asset-item id="dummy" src="" crossorigin="anonymous"></a-asset-item>
            </a-assets>

            <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

            <!-- Nodo anclado al target (primer target del .mind = índice 0) -->
            <a-entity id="anchor" mindar-image-target="targetIndex: 0">

                <!-- Plano 2D con el spritesheet -->
                <a-plane
                    id="kurtPlane"
                    material="src: #kurtSheet; transparent: true"
                    position="0 0 0"
                    rotation="0 0 0"
                    width="1.32" height="1.8"
                    sprite-animation="
                    src: #kurtSheet;
                    columns: 3;
                    rows: 1;
                    frameCount: 3;
                    fps: 3;
                    loop: true;
                    autoplay: false">
                </a-plane>
            </a-entity>
        </a-scene>

        <script>
            const sceneEl  = document.querySelector('a-scene');
            const arSystem = () => sceneEl.systems['mindar-image-system'];

            const ui       = document.getElementById('ui');
            const startBtn = document.getElementById('startBtn');
            const photoBtn = document.getElementById('photoBtn');
            const camBtn   = document.getElementById('camBtn');
            const plane    = document.getElementById('kurtPlane');
            const anchor   = document.getElementById('anchor');

            let usingBackCamera = true; // por defecto, trasera

            /**
             * Paso previo: forzar el PROMPT del sistema con getUserMedia()
             * - Debe ejecutarse justo después de un gesto del usuario (click en "Entrar")
             * - Si el usuario permite, cerramos el stream inmediatamente (no lo usamos)
             * - Luego arrancamos MindAR, que ya tendrá permiso y podrá abrir su propio vídeo
            */

            async function ensureCameraPermission() {
      // Facing mode: “environment” intenta usar la trasera; “user” la frontal
      const constraints = { video: { facingMode: { ideal: 'environment' } }, audio: false };

      // 1) Comprobación opcional del estado del permiso (no todos los navegadores lo soportan)
      try {
        if (navigator.permissions && navigator.permissions.query) {
          const status = await navigator.permissions.query({ name: 'camera' });
          // Si ya está concedido, no hace falta pedir stream; MindAR arrancará directamente.
          if (status.state === 'granted') return true;
          // Si está denegado permanentemente, avisamos al usuario para que vaya a Ajustes/Navegador
          if (status.state === 'denied') {
            throw new Error('La cámara está BLOQUEADA para este sitio. Ve a Ajustes del navegador → Cámara → Permitir para github.io');
          }
          // Si está en "prompt", seguiremos con getUserMedia para mostrar el diálogo.
        }
      } catch (e) {
        // Silenciamos errores de la Permissions API (no soportada en todos)
        console.warn('Permissions API no disponible o restringida:', e);
      }

      // 2) Esto dispara el PROMPT del sistema
      const stream = await navigator.mediaDevices.getUserMedia(constraints);

      // 3) Cerramos el stream temporal (MindAR abrirá el suyo)
      for (const track of stream.getTracks()) track.stop();

      return true;
    }

            // Arrancar AR al pulsar botón (permiso de cámara requiere gesto del usuario)
            startBtn.addEventListener('click', async () => {
                try {
                    await ensureCameraPermission(); // paso previo para forzar prompt
                    await arSystem().start();     // inicia cámara + tracking
                    ui.classList.add('hidden');
                    photoBtn.style.display = 'inline-block';
                    camBtn.style.display   = 'inline-block';
                } catch (e) {
                    alert(`No se pudo iniciar la cámara.\n${e.name ?? 'Error'}: ${e.message ?? e}`);
                    console.error(e);
                }
            });

            // Cuando el target aparece, arrancamos la animación del spritesheet
            anchor.addEventListener('targetFound', () => {
                plane.components['sprite-animation'].play();
            });
            anchor.addEventListener('targetLost', () => {
                plane.components['sprite-animation'].pause();
            });

            // Cambiar cámara (frontal/trasera)
            camBtn.addEventListener('click', async () => {
                usingBackCamera = !usingBackCamera;
                try {
                    await arSystem().switchCamera(usingBackCamera ? 'environment' : 'user');
                } catch (e) {
                    console.warn('Este dispositivo no soporta cambio de cámara dinámico.', e);
                }
            });

            // Botón de foto: usa el componente screenshot incluido en A-Frame
            photoBtn.addEventListener('click', () => {
                sceneEl.components.screenshot.capture('perspective');
                // A-Frame descarga automáticamente la imagen. Si prefieres dataURL:
                // const url = sceneEl.components.screenshot.getCanvas('perspective').toDataURL('image/png');
            });
        </script>
    </body>
</html>