<!DOCTYPE html>
<html lang="es">
    <head>
        <meta charset="utf-8"/>
        <meta name="viewport" content="width=device-width, initial-scale=1"/>
        <title>Kurtis fumando</title>

        <!-- Librerías desde CDN -->
        <script src="https://cdn.jsdelivr.net/npm/aframe@1.5.0/dist/aframe.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/mind-ar/dist/mindar-image-aframe.prod.js"></script>
        <!-- Componente de animación de sprites -->
        <script src="https://cdn.jsdelivr.net/npm/aframe-sprite-animation-component@3.8.0/dist/aframe-sprite-animation-component.min.js"></script>

        <style>
            html,body { margin:0; height:100%; overflow:hidden; background:#000; }
                #ui {
                    position:fixed; inset:0; display:flex; flex-direction:column;
                    align-items:center; justify-content:center; gap:12px; z-index:10; color:#fff;
                    background: radial-gradient(ellipse at center, rgba(0,0,0,.7) 0%, rgba(0,0,0,.4) 60%, rgba(0,0,0,0) 100%);
                    text-align:center; padding:24px;
                }
                button {
                    padding:12px 18px; font-size:16px; border-radius:12px; border:none; cursor:pointer;
                }
                #photoBtn, #camBtn {
                    position:fixed; bottom:16px; z-index:11; display:none;
                    background:#fff;
                }
                #photoBtn { right:16px; }
                #camBtn   { left:16px; }
                .hidden { display:none; }
        </style>
    </head>

    <body>
        <!-- UI inicial -->
        <div id="ui">
            <h2>Kurt fumando en Nirvana's</h2>
            <p>Apunta al marcador y toca “Entrar”.</p>
            <button id="startBtn">Entrar</button>
            <small>Si no ves la cámara, asegúrate de abrir la página por HTTPS.</small>
        </div>

        <button id="camBtn">Cambiar cámara</button>
        <button id="photoBtn">Foto</button>

        <!-- Escena AR (no autoStart: se arranca cuando esté 'loaded') -->
        <a-scene
            mindar-image="imageTargetSrc: ./targets.mind; autoStart: false;"
            renderer="colorManagement: true, physicallyCorrectLights"
            vr-mode-ui="enabled: false"
            device-orientation-permission-ui="enabled: false">

            <a-assets>
                <!-- El spritesheet PNG con transparencia -->
                <img id="kurtSheet" src="./spritesheet_kurt.png" />
                <!-- Habilita el componente screenshot de A-Frame para el botón Foto -->
                <!--<a-asset-item id="dummy" src="" crossorigin="anonymous"></a-asset-item>-->
            </a-assets>

            <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

            <!-- Nodo anclado al target (primer target del .mind = índice 0) -->
            <a-entity id="anchor" mindar-image-target="targetIndex: 0">

                <!-- Plano 2D con el spritesheet -->
                <a-plane
                    id="kurtPlane"
                    material="src: #kurtSheet; transparent: true"
                    position="0 0 0"
                    rotation="0 0 0"
                    width="1.32" height="1.8"
                    sprite-animation="
                    src: #kurtSheet;
                    columns: 3;
                    rows: 1;
                    frameCount: 3;
                    fps: 3;
                    loop: true;
                    autoplay: false">
                </a-plane>
            </a-entity>
        </a-scene>

        <script>
            const sceneEl  = document.querySelector('a-scene');
            const arSystem = () => sceneEl.systems['mindar-image-system'];

            const ui       = document.getElementById('ui');
            const startBtn = document.getElementById('startBtn');
            const photoBtn = document.getElementById('photoBtn');
            const camBtn   = document.getElementById('camBtn');
            const plane    = document.getElementById('kurtPlane');
            const anchor   = document.getElementById('anchor');

            let usingBackCamera = true; // por defecto, trasera

            // 1) Esperar a que la escena de A-Frame esté TOTALMENTE cargada.
            //    Hasta que no dispare 'loaded', los "systems" aún no existen.
            const whenSceneLoaded = new Promise(resolve => {
                if (sceneEl.hasLoaded) resolve();
                else sceneEl.addEventListener('loaded', resolve, { once: true });
            });

            // 2) Utilidad: obtener el sistema MindAR de forma segura (tras 'loaded').
            async function getMindARSystem() {
                await whenSceneLoaded; // garantizamos que A-Frame terminó de bootear
                const sys = sceneEl.systems['mindar-image-system'];
                if (!sys) throw new Error('MindAR no está inicializado todavía.');
                return sys;
            }
            
            // 3) Forzar el prompt de permisos ANTES de iniciar MindAR (tras el click).
            async function ensureCameraPermission() {
                // facingMode: environment intenta la trasera
                const constraints = { video: { facingMode: { ideal: 'environment' } }, audio: false };

                // Pedimos un stream temporal para que el SO muestre el diálogo de permiso
                const stream = await navigator.mediaDevices.getUserMedia(constraints);
                // Lo cerramos inmediatamente; MindAR abrirá el suyo
                for (const t of stream.getTracks()) t.stop();
            }

            // Arrancar AR al pulsar botón (permiso de cámara requiere gesto del usuario)
            startBtn.addEventListener('click', async () => {
                try {
                    await ensureCameraPermission(); // paso previo para forzar prompt
                    const mindar = await getMindARSystem(); // obtener sistema MindAR
                    await mindar.start();     // inicia cámara y tracking 
                    ui.classList.add('hidden');
                    photoBtn.style.display = 'inline-block';
                    camBtn.style.display   = 'inline-block';
                } catch (e) {
                    alert(`No se pudo iniciar la cámara.\n${e.name ?? 'Error'}: ${e.message ?? e}`);
                    console.error(e);
                }
            });

            // Cuando el target aparece, arrancamos la animación del spritesheet
            anchor.addEventListener('targetFound', () => {
                plane.components['sprite-animation'].play();
            });
            anchor.addEventListener('targetLost', () => {
                plane.components['sprite-animation'].pause();
            });

            // Cambiar cámara (frontal/trasera)
            camBtn.addEventListener('click', async () => {
                usingBackCamera = !usingBackCamera;
                try {
                    await arSystem().switchCamera(usingBackCamera ? 'environment' : 'user');
                } catch (e) {
                    console.warn('Este dispositivo no soporta cambio de cámara dinámico.', e);
                }
            });

            
            // Botón de foto: usa el componente screenshot incluido en A-Frame
            photoBtn.addEventListener('click', () => {
                sceneEl.components.screenshot.capture('perspective');
                // A-Frame descarga automáticamente la imagen. Si prefieres dataURL:
                // const url = sceneEl.components.screenshot.getCanvas('perspective').toDataURL('image/png');
            });
        </script>
    </body>
</html>